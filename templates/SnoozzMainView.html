<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drowsiness detecter</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .camera-container {
            position: relative;
            border: 5px solid #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
        }

        .fps-display {
            position: absolute;
            top: 5px;
            left: 10px;
            padding: 5px 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 5px;
        }

        .ear-display {
            position: absolute;
            top: 30px;
            left: 10px;
            padding: 5px 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 5px;
        }

        .blinktime-display {
            position: absolute;
            top: 55px;
            left: 10px;
            padding: 5px 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 5px;
        }

        .durmean-display {
            position: absolute;
            top: 80px;
            left: 10px;
            padding: 5px 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 5px;
        }

        .long10-display {
            position: absolute;
            top: 105px;
            left: 10px;
            padding: 5px 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 5px;
        }

        .slpc-display {
            position: absolute;
            top: 130px;
            left: 10px;
            padding: 5px 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 5px;
        }

        .slpd-display {
            position: absolute;
            top: 155px;
            left: 10px;
            padding: 5px 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 5px;
        }

        .indicator-container {
            margin-top: 10px;
            text-align: center;
            width: 100%;
        }

        .indicator {
            display: inline-block;
            width: 100%;
            height: 80px;
            line-height: 80px;
            border-radius: 10px;
            font-size: 70px;
            font-weight: bold;
            color: white;
            text-align: center;
        }

        .open {
            background-color: rgb(159, 225, 255);
        }

        .closed {
            background-color: rgb(255, 201, 201);
        }

        .nofacedetected {
            background-color: gray;
        }

        video {
            display: none;
        }

        /* Ëµ§„ÅÑËÉåÊôØ„ÅßË≠¶ÂëäË°®Á§∫ */
        .warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.8);
            color: rgb(47, 0, 0);
            font-size: 60px;
            font-weight: bold;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            /*writing-mode: vertical-rl;*/
            /* Á∏¶Êõ∏„Åç */
        }

        .tab-header {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .tab-button {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: none;
            border-bottom: 2px solid transparent;
            transition: background-color 0.3s, border-bottom-color 0.3s;
        }

        .tab-button.active {
            background-color: #ffffff;
            border-bottom: 2px solid #007bff;
            font-weight: bold;
        }

        .tab-button:hover {
            background-color: #e0e0e0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: flex;
        }
    </style>
</head>

<body>
    <div class="camera-container">
        <canvas id="canvas"></canvas>
        <video id="video" playsinline></video>
        <div id="fpsDisplay" class="fps-display">FPS: 0</div>
        <div id="earDisplay" class="ear-display">EAR: 0</div>
        <div id="blinktimeDisplay" class="blinktime-display">BlinkTime: 0</div>
        <div id="durmeanDisplay" class="durmean-display">DurMean: 0</div>
        <div id="long10Display" class="long10-display">Long10: 0</div>
        <div id="slpcDisplay" class="slpc-display">SleapnessC: Measuring...</div>
        <div id="slpdDisplay" class="slpd-display">SleapnessD: Measuring...</div>
    </div>
    <div class="indicator-container">
        <!-- „Çø„Éñ„Éò„ÉÉ„ÉÄ„Éº -->
        <div class="tab-header">
            <button class="tab-button active" onclick="openTab('eyeStateTab')">Eye State</button>
            <button class="tab-button" onclick="openTab('blinkDataTab')">Blink Data</button>
            <button class="tab-button" onclick="openTab('settingTab')">Setting</button>
        </div>
        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="tab-content" id="eyeStateTab">
            <div id="eyeState" class="indicator">Loading...</div>
        </div>
        <div class="tab-content" id="blinkDataTab" style="display:none;">
            <div id="blinkDataGrid"
                style="display: grid; grid-template-columns: 1fr; gap: 5px; margin-top: 10px; width: 100%; border: 1px solid #ccc; border-radius: 5px; overflow: hidden;">
            </div>
        </div>
        <div class="tab-content" id="settingTab" style="display:none;">
            <div style="margin-top: 10px; width: 100%; display: flex; flex-direction: column; align-items: flex-start;">
                <!-- durCriË®≠ÂÆö -->
                <div style="display: flex; align-items: center; margin-bottom: 15px; width: 100%;">
                    <label for="durCriSlider" style="margin-right: 10px; width: 30%;">DurCri: </label>
                    <input type="number" id="durCriValue" min="50" max="200" step="5" value="100"
                        style="width: 10%; margin-right: 10px;"
                        oninput="updateValue('durCriSlider',this.value,'DurCri')">
                    <input type="range" id="durCriSlider" min="50" max="200" step="5" value="100" style="width: 70%;"
                        oninput="updateValue('durCriValue',this.value,'DurCri')">
                </div>

                <!-- Áû¨ÁõÆEARÈñæÂÄ§ -->
                <div style="display: flex; align-items: center; width: 100%;">
                    <label for="earThrSlider" style="margin-right: 10px; width: 30%;">EarThr: </label>
                    <input type="number" id="earThrValue" min="0.0" max="1.0" step="0.01" value="0.1"
                        style="width: 10%; margin-right: 10px;"
                        oninput="updateValue('earThrSlider',this.value,'EAR_THRESHOLD')">
                    <input type="range" id="earThrSlider" min="0.0" max="1.0" step="0.01" value="0.1"
                        style="width: 70%;" oninput="updateValue('earThrValue',this.value,'EAR_THRESHOLD')">
                </div>
            </div>
        </div>


    </div>

    <div id="warningMessage" class="warning" style="display: none;">
        Drowsiness detected
    </div>

    <script>
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const fpsDisplay = document.getElementById('fpsDisplay');
        const eyeStateElement = document.getElementById('eyeState');

        //Áú†Ê∞óÊ§úÂá∫Áî®„ÅÆÂ§âÊï∞
        var EarThreshold = 0.1; // ÁõÆ„ÇíÈñâ„Åò„Å¶„ÅÑ„Çã„Å®„Åø„Å™„ÅôÈñæÂÄ§
        var CheckInterval = 5; // Áú†Ê∞ó„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Ç§„É≥„Çø„Éº„Éê„É´[s]
        let BlinkDatas = []; //Áû¨„Åç„Éá„Éº„Çø„Çí‰øùÊåÅ„Åô„Çã { timestamp, duration } „ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó
        let BlinkStartTime = null; // Áû¨„ÅçÈñãÂßãÊôÇÂàª
        let BlinkDurations = [];   // Áû¨„Åç„ÅÆÁ∂ôÁ∂öÊôÇÈñì„É™„Çπ„Éà
        let DurMean = 0.0;
        let DurCri = 130.0;
        let Long10 = 0.0;
        let SleapnessC = 0.0;
        let SleapnessD = 0.0;
        let CheckSleapness = false;// Áú†Ê∞ó„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Åã„ÅÆ„Éï„É©„Ç∞               

        // EARË®àÁÆóÁî®„ÅÆÁõÆ„ÅÆ„É©„É≥„Éâ„Éû„Éº„ÇØ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        const LEFT_EYE = [362, 385, 387, 263, 373, 380];
        const RIGHT_EYE = [33, 160, 158, 133, 153, 144];

        // FPSË®àÁÆóÁî®„ÅÆÂ§âÊï∞
        let FrameCount = 0;
        let LastTimestamp = performance.now();

        // ÂàùÊúüË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
        document.addEventListener("DOMContentLoaded", () => {
            const savedDurCri = localStorage.getItem("DurCri");
            const defaultDurCri = savedDurCri ? parseFloat(savedDurCri) : 100; // ‰øùÂ≠ò„Åï„Çå„ÅüÂÄ§„ÄÅ„Åæ„Åü„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§
            document.getElementById("durCriSlider").value = defaultDurCri;
            document.getElementById("durCriValue").value = defaultDurCri;
            DurCri = defaultDurCri;
            console.log(`Loaded DurCri: ${DurCri}`);

            const savedEarThr = localStorage.getItem("EAR_THRESHOLD");
            const defaultEarThr = savedEarThr ? parseFloat(savedEarThr) : 0.1; // ‰øùÂ≠ò„Åï„Çå„ÅüÂÄ§„ÄÅ„Åæ„Åü„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§
            document.getElementById("earThrSlider").value = defaultEarThr;
            document.getElementById("earThrValue").value = defaultEarThr;
            window['EarThreshold'] = defaultEarThr;
            console.log(`Loaded EAR_THRESHOLD: ${EarThreshold}`);
        });

        // Ê±éÁî®ÁöÑ„Å™„Çπ„É©„Ç§„ÉÄ„Éº„Å®„ÉÜ„Ç≠„Çπ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂêåÊúüÈñ¢Êï∞
        function updateValue(elementId, value, variableName) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value; // ÂØæË±°„ÅÆË¶ÅÁ¥†„ÇíÊõ¥Êñ∞
            }
            window[variableName] = parseFloat(value); // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíÊõ¥Êñ∞
            saveToLocalStorage(variableName, window[variableName]); // ‰øùÂ≠òÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
        }

        // Ê±éÁî®ÁöÑ„Å™„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏‰øùÂ≠òÈñ¢Êï∞
        function saveToLocalStorage(key, value) {
            localStorage.setItem(key, value);
            console.log(`Saved ${key}: ${value}`);
        }

        // „Çø„Éñ„ÅÆÂàá„ÇäÊõø„ÅàÂá¶ÁêÜ
        function openTab(tabId) {
            // „Çø„Éñ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.style.display = 'none');

            // ÂÖ®„Å¶„ÅÆ„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇØ„É©„Çπ„ÇíÂâäÈô§
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„ÇíË°®Á§∫
            document.getElementById(tabId).style.display = 'flex';

            // ÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇØ„É©„Çπ„ÇíËøΩÂä†
            event.currentTarget.classList.add('active');
        }

        // „Ç∞„É™„ÉÉ„Éâ„ÇíÊõ¥Êñ∞
        function updateBlinkDataGrid() {
            const grid = document.getElementById('blinkDataGrid');
            grid.innerHTML = ''; // Êó¢Â≠ò„ÅÆ„Ç∞„É™„ÉÉ„ÉâÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢

            // „Ç∞„É™„ÉÉ„Éâ„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„Çí‰ΩúÊàê
            const headerRow = document.createElement('div');
            headerRow.style.display = 'grid';
            headerRow.style.gridTemplateColumns = '1fr 1fr';
            headerRow.style.fontWeight = 'bold';
            headerRow.style.backgroundColor = '#ddd';
            headerRow.style.borderBottom = '2px solid #aaa';

            const timeHeader = document.createElement('div');
            timeHeader.textContent = 'Time';
            timeHeader.style.padding = '5px';
            timeHeader.style.textAlign = 'center';

            const durationHeader = document.createElement('div');
            durationHeader.textContent = 'Duration';
            durationHeader.style.padding = '5px';
            durationHeader.style.textAlign = 'center';

            headerRow.appendChild(timeHeader);
            headerRow.appendChild(durationHeader);
            grid.appendChild(headerRow);

            // Áû¨ÁõÆ„Éá„Éº„Çø„ÇíÈÄÜÈ†Ü„ÅßË°®Á§∫
            BlinkDatas.slice().reverse().forEach((data) => {
                const row = document.createElement('div');
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '1fr 1fr';
                row.style.borderBottom = '1px solid #ddd';

                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÇíÊó•Êú¨ÊôÇÈñì„Åß„Éï„Ç©„Éº„Éû„ÉÉ„Éà
                const time = new Intl.DateTimeFormat('ja-JP', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                }).format(data.timestamp);

                const duration = `${Math.round(data.duration * 100) / 100} ms`;

                const timeCell = document.createElement('div');
                timeCell.textContent = time;
                timeCell.style.padding = '5px';
                timeCell.style.textAlign = 'center';

                const durationCell = document.createElement('div');
                durationCell.textContent = duration;
                durationCell.style.padding = '5px';
                durationCell.style.textAlign = 'center';

                row.appendChild(timeCell);
                row.appendChild(durationCell);
                grid.appendChild(row);
            });
        }

        // Áû¨„ÅçÊôÇÈñì„ÇíËøΩË∑°
        function trackBlink(avgEAR, timestamp) {
            const FIVE_MINUTES = 5 * 60 * 1000; // 5ÂàÜ„ÅÆ„Éü„É™Áßí
            const currentTime = Date.now(); // ÁèæÂú®„ÅÆÊôÇÂàª

            // Âè§„ÅÑ„Éá„Éº„Çø„ÇíÂâäÈô§Ôºà5ÂàÜ‰ª•‰∏äÂâç„ÅÆ„Éá„Éº„Çø„ÇíÈô§Â§ñÔºâ
            BlinkDatas = BlinkDatas.filter(data => currentTime - data.timestamp <= FIVE_MINUTES);

            if (BlinkDatas.length === 10 && CheckSleapness === false) {
                CheckSleapness = true;
            }

            if (avgEAR <= EarThreshold) {
                // ÁõÆ„ÅåÈñâ„ÅòÂßã„ÇÅ„ÅüÂ†¥Âêà
                if (BlinkStartTime === null) {
                    BlinkStartTime = timestamp; // Áû¨„ÅçÈñãÂßãÊôÇÈñì„ÇíË®òÈå≤
                }
            }
            else {
                // ÁõÆ„ÅåÈñã„ÅÑ„ÅüÂ†¥Âêà
                if (BlinkStartTime !== null) {
                    const blinkDuration = timestamp - BlinkStartTime; // Áû¨„Åç„ÅÆÁ∂ôÁ∂öÊôÇÈñì„ÇíË®àÁÆó
                    BlinkDatas.push({ timestamp: currentTime, duration: blinkDuration }); // „Éá„Éº„Çø„ÇíÈÖçÂàó„Å´ËøΩÂä†

                    console.log(`Blink Duration: ${blinkDuration} ms`);
                    blinktimeDisplay.textContent = `BlinkTime: ${Math.round(blinkDuration * 100) / 100} ms`;
                    BlinkStartTime = null; // Áû¨„ÅçÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà

                    // „Ç∞„É™„ÉÉ„Éâ„ÇíÊõ¥Êñ∞
                    updateBlinkDataGrid();
                }
            }

            DurMean = calculateDurMean(BlinkDatas);
            Long10 = calculateLong10(BlinkDatas);
            if (CheckSleapness === true) {
                SleapnessC = calculateSleapnessC(Long10);
                SleapnessD = calculateSleapnessD(DurMean);
            }
        }

        // EAR„ÇíË®àÁÆó
        function calculateEAR(landmarks, eyeIndices) {
            const p1 = landmarks[eyeIndices[1]];
            const p2 = landmarks[eyeIndices[5]];
            const p3 = landmarks[eyeIndices[2]];
            const p4 = landmarks[eyeIndices[4]];
            const p0 = landmarks[eyeIndices[0]];
            const p3_ = landmarks[eyeIndices[3]];

            // Á∏¶ÊñπÂêë„ÅÆË∑ùÈõ¢
            const vertical1 = Math.sqrt((p2.x - p1.x) ** 2 + (p2.y - p1.y) ** 2);
            const vertical2 = Math.sqrt((p4.x - p3.x) ** 2 + (p4.y - p3.y) ** 2);
            // Ê®™ÊñπÂêë„ÅÆË∑ùÈõ¢
            const horizontal = Math.sqrt((p0.x - p3_.x) ** 2 + (p0.y - p3_.y) ** 2);

            // EARË®àÁÆó
            return (vertical1 + vertical2) / (2.0 * horizontal);
        }

        // DurMean„ÇíË®àÁÆó
        function calculateDurMean(blinkDatas) {
            let retDurMean = 0.0
            if (blinkDatas.length > 0) {
                const totalDuration = blinkDatas.reduce((sum, data) => sum + data.duration, 0);
                retDurMean = totalDuration / blinkDatas.length;
                durmeanDisplay.textContent = `DurMean: ${Math.round(DurMean * 100) / 100} ms`;
            }
            return retDurMean;
        }

        // Long10„ÇíË®àÁÆó
        function calculateLong10(blinkDatas) {
            const Nlong = blinkDatas.filter(data => data.duration > DurCri * 1.1).length;
            const NAnother = blinkDatas.length - Nlong;
            const retLong10 = (Nlong / (Nlong + NAnother)) * 100;
            long10Display.textContent = `Long10: ${Math.round(retLong10 * 100) / 100}`;

            return retLong10;
        }

        // SleapnessC„ÇíË®àÁÆó
        function calculateSleapnessC(long10) {
            const retSlpC = 1.238 + 0.046 * long10
            if (retSlpC === 0) {
                slpcDisplay.textContent = `SleapnessC: 0`;
            } else {
                slpcDisplay.textContent = `SleapnessC: ${Math.round(retSlpC * 100) / 100}`;
            }
            return retSlpC;
        }

        // SleapnessD„ÇíË®àÁÆó
        function calculateSleapnessD(durMean) {
            const retSlpD = -4.378 + 0.029 * durMean
            if (retSlpD === 0) {
                slpdDisplay.textContent = `SleapnessD: 0`;
            } else {
                slpdDisplay.textContent = `SleapnessD: ${Math.round(retSlpD * 100) / 100}`;
            }
            return retSlpD;
        }

        // FPS„ÇíË®àÁÆó
        function calclateFPS() {
            FrameCount++;
            const now = performance.now();
            const elapsed = now - LastTimestamp;
            if (elapsed >= 1000) {
                const fps = Math.round((FrameCount / elapsed) * 100000) / 100;
                fpsDisplay.textContent = `FPS: ${fps}`;
                FrameCount = 0;
                LastTimestamp = now;
            }
        }

        // Mediapipe FaceMeshË®≠ÂÆö
        const faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
        });

        // Mediapipe FaceMeshË®≠ÂÆö
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5,
        });

        // MediaPipe„ÅÆÊ§úÂá∫ÂÆå‰∫Ü„Ç§„Éô„É≥„Éà
        faceMesh.onResults((results) => {
            const timestamp = performance.now(); // ÁèæÂú®„ÅÆÊôÇÂàª„ÇíÂèñÂæó
            canvasElement.width = results.image.width;
            canvasElement.height = results.image.height;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];

                // Â∑¶ÁõÆ„Å®Âè≥ÁõÆ„ÅÆEAR„ÇíË®àÁÆó
                const leftEAR = calculateEAR(landmarks, LEFT_EYE);
                const rightEAR = calculateEAR(landmarks, RIGHT_EYE);
                const avgEAR = (leftEAR + rightEAR) / 2;

                earDisplay.textContent = `EAR: ${Math.round(avgEAR * 100) / 100}`;

                // Áû¨„ÅçÊôÇÈñì„ÇíËøΩË∑°
                trackBlink(avgEAR, timestamp);

                // „É°„ÉÉ„Ç∑„É•„ÇíÊèèÁîª
                drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, { color: '#C0C0C070', lineWidth: 1 });
                drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYE, { color: '#FF3030', lineWidth: 1 });
                drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYE, { color: '#30FF30', lineWidth: 1 });
                drawConnectors(canvasCtx, landmarks, FACEMESH_FACE_OVAL, { color: '#E0E0E0', lineWidth: 1 });

                // EAR„Å´Âü∫„Å•„ÅÑ„Å¶„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                if (avgEAR > EarThreshold) {
                    eyeStateElement.textContent = "üò≥";
                    eyeStateElement.className = "indicator open";
                } else {
                    eyeStateElement.textContent = "üòå";
                    eyeStateElement.className = "indicator closed";
                }
            } else {
                eyeStateElement.textContent = "ü´•";
                eyeStateElement.className = "indicator nofacedetected";
            }

            canvasCtx.restore();
            calclateFPS();
        });

        // ‰ΩøÁî®ÂèØËÉΩ„Å™„Ç´„É°„É©„Éá„Éê„Ç§„Çπ„ÇíÂèñÂæó
        async function getCameras() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            // „Ç´„É°„É©„Éá„Éê„Ç§„Çπ (videoinput) „ÇíÊäΩÂá∫
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            return videoDevices;
        }

        // ÁâπÂÆö„ÅÆ„Ç´„É°„É©„ÇíÈÅ∏Êäû„Åó„Å¶Ëµ∑Âãï
        async function startCamera(deviceId) {
            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined, // „Ç´„É°„É©„ÇíÊåáÂÆö („Éá„Éï„Ç©„É´„Éà„ÅØËá™ÂãïÈÅ∏Êäû)
                    width: 640, // Ëß£ÂÉèÂ∫¶„ÇíÊåáÂÆö
                    height: 480,
                    frameRate: { ideal: 60, max: 60 } // FPS „ÇíÊåáÂÆö
                }
            };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                // Êò†ÂÉè„Çí <video> Ë¶ÅÁ¥†„Å´Ë®≠ÂÆö
                const videoElement = document.querySelector('video');
                videoElement.srcObject = stream;
                videoElement.play();

                const camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await faceMesh.send({ image: videoElement }); // FaceMesh „Å´„Éï„É¨„Éº„É†„ÇíÈÄÅ‰ø°
                    },
                    width: 640,
                    height: 480,
                });
                camera.start(); // „Ç´„É°„É©„ÅÆÂá¶ÁêÜ„ÇíÈñãÂßã

            } catch (error) {
                console.error('Error accessing the camera:', error);
            }
        }

        // init
        async function init() {
            const cameras = await getCameras();
            console.log('Available Cameras:', cameras);

            if (cameras.length > 0) {
                // ÊúÄÂàù„ÅÆ„Ç´„É°„É©„Çí‰ΩøÁî®
                await startCamera(cameras[0].deviceId);
            } else {
                console.error('No cameras found.');
            }

            // ÊúÄÂàù„ÅÆ„Çø„Éñ„ÇíË°®Á§∫
            document.getElementById('eyeStateTab').style.display = 'flex';

            // 1ÂàÜ„Åä„Åç„Å´ SleapnessD „Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Çø„Ç§„Éû„Éº„ÇíË®≠ÂÆö
            setInterval(() => {
                if (SleapnessC > 3 || SleapnessD > 3) {
                    console.warn("Ë≠¶Âëä");
                    document.getElementById('warningMessage').style.display = 'flex';
                } else {
                    console.log("Ê≠£Â∏∏");
                    document.getElementById('warningMessage').style.display = 'none';
                }
            }, CheckInterval * 1000);
        }

        init();

        /*
        Âá¶ÁêÜAÔºö
            Âü∫Ê∫ñÁû¨ÁõÆÊåÅÁ∂öÊôÇÈñì„ÅÆË®àÊ∏¨
            DurCri[ms]ÔºùÔºà5ÂàÜÈñì„Å´„Åó„ÅüÁû¨ÁõÆÊåÅÁ∂öÊôÇÈñì„ÅÆÂêàË®à[ms]/Áû¨ÁõÆÂõûÊï∞[Âõû]Ôºâ/300000[ms]

        Âá¶ÁêÜBÔºöBÔΩûD„ÅØÁõ¥Ëøë5ÂàÜÈñì„ÅÆÁû¨ÁõÆ„ÇíÂØæË±°„Å®„Åô„Çã‚Üí5ÂàÜ„Åü„Å£„ÅüÁû¨ÁõÆ„Éá„Éº„Çø„ÅØÂâäÈô§„Åô„Çã
            DurMean[ms]=Ôºà5ÂàÜÈñì„Å´„Åó„ÅüÁû¨ÁõÆÊåÅÁ∂öÊôÇÈñì„ÅÆÂêàË®à[ms]/Áû¨ÁõÆÂõûÊï∞[Âõû]Ôºâ
            Long10=Nlong/(Nlong+NAnother)
            Nlong = DurCri*1.1‰ª•‰∏ä„ÅÆÂÄãÊï∞
            NAnother = Áû¨ÁõÆÂõûÊï∞ - Nlong
        Âá¶ÁêÜCÔºö
            SleapnessC=1.238+0.046*Long10
        Âá¶ÁêÜDÔºö
            SleapnessD=-4.378+0.029*DurMean

        Âá¶ÁêÜEÔºö1ÂàÜ„Åä„Åç„Å´Âà§ÂÆö
            SleapnessC>3||SleapnessD>3
            ‚ÜíË≠¶Âëä
            SleapnessC=<3&&SleapnessD=<3
            ‚ÜíB„Å´Êàª„Çã
        */
    </script>
</body>

</html>